name: release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify tag/version/changelog
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: pnpm release:verify-tag

      - name: Release gate
        run: pnpm release:gate

      - name: Publish to npm (trusted publishing)
        run: |
          if [ -n "${NODE_AUTH_TOKEN:-}" ] || [ -n "${NPM_TOKEN:-}" ]; then
            echo "::error::Trusted publishing mode forbids NODE_AUTH_TOKEN/NPM_TOKEN in workflow env."
            exit 1
          fi

          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ] && [ -f "${NPM_CONFIG_USERCONFIG}" ]; then
            awk '!/_authToken/' "${NPM_CONFIG_USERCONFIG}" > /tmp/npmrc.trusted
            mv /tmp/npmrc.trusted "${NPM_CONFIG_USERCONFIG}"
          fi

          unset NODE_AUTH_TOKEN NPM_TOKEN
          npm publish --access public --provenance

      - name: Build release notes from changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          node scripts/changelog-release-notes.mjs "$VERSION" > /tmp/release-notes.md

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$TAG" --notes-file /tmp/release-notes.md
          else
            gh release create "$TAG" --title "$TAG" --notes-file /tmp/release-notes.md
          fi
